<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClaudeÃ—3D ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ«ãƒ¼ãƒ è¨­è¨ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }
        
        .main-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 100vh;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            border-right: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .panel-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .input-group {
            margin-bottom: 12px;
        }
        
        .input-label {
            display: block;
            font-size: 0.9em;
            color: #555;
            margin-bottom: 5px;
        }
        
        .input-field {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .input-field:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: transform 0.2s ease;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .button:hover {
            transform: scale(1.02);
        }
        
        .button.secondary {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }
        
        .button.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }
        
        .viewer-container {
            position: relative;
            background: #1a1a1a;
            overflow: hidden;
        }
        
        #roomViewer {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .viewer-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            color: white;
        }
        
        .control-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin: 2px;
            font-size: 0.8em;
        }
        
        .control-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .furniture-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        
        .furniture-item {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85em;
        }
        
        .furniture-item:hover {
            border-color: #667eea;
            background: #e7f1ff;
        }
        
        .furniture-item.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .claude-chat {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.85em;
            line-height: 1.4;
        }
        
        .chat-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
            margin-top: 8px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.8em;
            color: #666;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2em;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .layout-preset {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85em;
        }
        
        .layout-preset:hover {
            border-color: #667eea;
            background: #f0f8ff;
        }
        
        .notification {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div class="main-container">
        <div class="control-panel">
            <h2 class="panel-title">ğŸ  ãƒ«ãƒ¼ãƒ è¨­è¨ˆã‚·ã‚¹ãƒ†ãƒ </h2>
            
            <!-- éƒ¨å±‹è¨­å®š -->
            <div class="section">
                <div class="section-title">ğŸ“ éƒ¨å±‹ã®åŸºæœ¬è¨­å®š</div>
                <div class="input-group">
                    <label class="input-label">å¹… (m)</label>
                    <input type="number" class="input-field" id="roomWidth" value="4" min="2" max="10" step="0.1">
                </div>
                <div class="input-group">
                    <label class="input-label">å¥¥è¡Œã (m)</label>
                    <input type="number" class="input-field" id="roomDepth" value="3" min="2" max="10" step="0.1">
                </div>
                <div class="input-group">
                    <label class="input-label">é«˜ã• (m)</label>
                    <input type="number" class="input-field" id="roomHeight" value="2.4" min="2" max="4" step="0.1">
                </div>
                <button class="button" onclick="updateRoom()">ğŸ—ï¸ éƒ¨å±‹ã‚’æ›´æ–°</button>
            </div>
            
            <!-- å®¶å…·è¿½åŠ  -->
            <div class="section">
                <div class="section-title">ğŸª‘ å®¶å…·ã®è¿½åŠ </div>
                <div class="furniture-grid">
                    <div class="furniture-item" onclick="addFurniture('bed')">
                        ğŸ›ï¸<br>ãƒ™ãƒƒãƒ‰
                    </div>
                    <div class="furniture-item" onclick="addFurniture('desk')">
                        ğŸ—„ï¸<br>ãƒ‡ã‚¹ã‚¯
                    </div>
                    <div class="furniture-item" onclick="addFurniture('chair')">
                        ğŸª‘<br>æ¤…å­
                    </div>
                    <div class="furniture-item" onclick="addFurniture('bookshelf')">
                        ğŸ“š<br>æœ¬æ£š
                    </div>
                    <div class="furniture-item" onclick="addFurniture('wardrobe')">
                        ğŸ‘”<br>ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ
                    </div>
                    <div class="furniture-item" onclick="addFurniture('sofa')">
                        ğŸ›‹ï¸<br>ã‚½ãƒ•ã‚¡
                    </div>
                </div>
                <button class="button danger" onclick="clearFurniture()">ğŸ—‘ï¸ å…¨ã¦å‰Šé™¤</button>
            </div>
            
            <!-- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆ -->
            <div class="section">
                <div class="section-title">âœ¨ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆ</div>
                <div class="layout-preset" onclick="applyLayout('study')">
                    ğŸ“– å‹‰å¼·éƒ¨å±‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
                </div>
                <div class="layout-preset" onclick="applyLayout('bedroom')">
                    ğŸ›ï¸ å¯å®¤ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
                </div>
                <div class="layout-preset" onclick="applyLayout('workspace')">
                    ğŸ’» ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
                </div>
                <div class="layout-preset" onclick="applyLayout('minimal')">
                    ğŸŒ¿ ãƒŸãƒ‹ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«
                </div>
            </div>
            
            <!-- Claude AIç›¸è«‡ -->
            <div class="section">
                <div class="section-title">ğŸ¤– Claude AI ç›¸è«‡</div>
                <div class="claude-chat" id="claudeChat">
                    <div style="color: #667eea; font-weight: bold;">Claude:</div>
                    <div>ã“ã‚“ã«ã¡ã¯ï¼éƒ¨å±‹ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«ã¤ã„ã¦ä½•ã§ã‚‚ã”ç›¸è«‡ãã ã•ã„ã€‚ã€Œã‚‚ã£ã¨åºƒãè¦‹ã›ãŸã„ã€ã€Œåç´ã‚’å¢—ã‚„ã—ãŸã„ã€ãªã©ã€ãŠæ°—è»½ã«ã©ã†ãã€‚</div>
                </div>
                <input type="text" class="chat-input" id="claudeInput" placeholder="ä¾‹ï¼šã‚‚ã£ã¨é–‹æ”¾æ„Ÿã®ã‚ã‚‹é…ç½®ã«ã—ãŸã„..." onkeypress="handleChatEnter(event)">
                <button class="button secondary" onclick="sendToClaude()">ğŸ’¬ ç›¸è«‡ã™ã‚‹</button>
            </div>
            
            <!-- ç©ºé–“åˆ†æ -->
            <div class="section">
                <div class="section-title">ğŸ“Š ç©ºé–“åˆ†æ</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="utilizationRate">75%</div>
                        <div class="stat-label">åˆ©ç”¨ç‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="walkingDistance">3.2m</div>
                        <div class="stat-label">å¹³å‡å‹•ç·š</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="openSpace">40%</div>
                        <div class="stat-label">é–‹æ”¾æ„Ÿ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="efficiency">B+</div>
                        <div class="stat-label">åŠ¹ç‡æ€§</div>
                    </div>
                </div>
                <button class="button secondary" onclick="analyzeSpace()">ğŸ”„ å†åˆ†æ</button>
            </div>
            
            <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
            <div class="section">
                <div class="section-title">ğŸ’¾ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
                <button class="button" onclick="exportToBlender()">ğŸ“¤ Blenderã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</button>
                <button class="button secondary" onclick="saveLayout()">ğŸ’¿ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿å­˜</button>
                <button class="button secondary" onclick="takeScreenshot()">ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ</button>
            </div>
        </div>
        
        <div class="viewer-container">
            <canvas id="roomViewer"></canvas>
            
            <div class="viewer-controls">
                <div style="margin-bottom: 10px; font-weight: bold;">ğŸ® æ“ä½œ</div>
                <button class="control-button" onclick="resetCamera()">ğŸ¯ è¦–ç‚¹ãƒªã‚»ãƒƒãƒˆ</button>
                <button class="control-button" onclick="toggleWireframe()">ğŸ”² ãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ </button>
                <button class="control-button" onclick="toggleGrid()">ğŸ“ ã‚°ãƒªãƒƒãƒ‰</button>
                <div style="margin-top: 10px; font-size: 0.8em; opacity: 0.8;">
                    ãƒã‚¦ã‚¹: å›è»¢ãƒ»ç§»å‹•<br>
                    ãƒ›ã‚¤ãƒ¼ãƒ«: ã‚ºãƒ¼ãƒ <br>
                    å®¶å…·: ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ
                </div>
            </div>
            
            <div class="loading" id="loadingIndicator" style="display: none;">
                <div class="spinner"></div>
                <div>3Dã‚·ãƒ¼ãƒ³ã‚’æ§‹ç¯‰ä¸­...</div>
            </div>
            
            <div class="notification" id="notification"></div>
        </div>
    </div>
    
    <script>
        // Three.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        let scene, camera, renderer, controls;
        let room, furniture = [];
        let selectedObject = null;
        let roomWidth = 4, roomDepth = 3, roomHeight = 2.4;
        let showWireframe = false, showGrid = true;
        
        // å®¶å…·ã®å®šç¾©
        const furnitureDefinitions = {
            bed: { width: 1.2, depth: 2.0, height: 0.3, color: 0x8B4513, name: 'ãƒ™ãƒƒãƒ‰' },
            desk: { width: 1.2, depth: 0.6, height: 0.75, color: 0x654321, name: 'ãƒ‡ã‚¹ã‚¯' },
            chair: { width: 0.5, depth: 0.5, height: 0.9, color: 0x2F4F4F, name: 'æ¤…å­' },
            bookshelf: { width: 0.3, depth: 1.8, height: 2.0, color: 0x8B4513, name: 'æœ¬æ£š' },
            wardrobe: { width: 0.6, depth: 1.8, height: 2.0, color: 0x696969, name: 'ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ' },
            sofa: { width: 0.8, depth: 1.8, height: 0.8, color: 0x4682B4, name: 'ã‚½ãƒ•ã‚¡' }
        };
        
        init();
        
        function init() {
            showLoading(true);
            
            // ã‚·ãƒ¼ãƒ³ä½œæˆ
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);
            
            // ã‚«ãƒ¡ãƒ©ä½œæˆ
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(5, 4, 5);
            camera.lookAt(0, 0, 0);
            
            // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ä½œæˆ
            const canvas = document.getElementById('roomViewer');
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // ç…§æ˜è¨­å®š
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // ã‚°ãƒªãƒƒãƒ‰
            const gridHelper = new THREE.GridHelper(10, 10);
            gridHelper.name = 'grid';
            scene.add(gridHelper);
            
            // ç°¡æ˜“ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆãƒã‚¦ã‚¹æ“ä½œï¼‰
            setupControls();
            
            // åˆæœŸéƒ¨å±‹ä½œæˆ
            createRoom();
            
            // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
            animate();
            
            showLoading(false);
            showNotification('3Déƒ¨å±‹è¨­è¨ˆã‚·ã‚¹ãƒ†ãƒ ãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸï¼');
        }
        
        function setupControls() {
            let isMouseDown = false;
            let mouseX = 0, mouseY = 0;
            let targetX = 0, targetY = 0;
            let distance = 8;
            
            const canvas = document.getElementById('roomViewer');
            
            canvas.addEventListener('mousedown', (event) => {
                isMouseDown = true;
                mouseX = event.clientX;
                mouseY = event.clientY;
            });
            
            canvas.addEventListener('mousemove', (event) => {
                if (!isMouseDown) return;
                
                const deltaX = event.clientX - mouseX;
                const deltaY = event.clientY - mouseY;
                
                targetX += deltaX * 0.01;
                targetY += deltaY * 0.01;
                
                mouseX = event.clientX;
                mouseY = event.clientY;
                
                updateCameraPosition();
            });
            
            canvas.addEventListener('mouseup', () => {
                isMouseDown = false;
            });
            
            canvas.addEventListener('wheel', (event) => {
                distance += event.deltaY * 0.01;
                distance = Math.max(3, Math.min(15, distance));
                updateCameraPosition();
                event.preventDefault();
            });
            
            function updateCameraPosition() {
                camera.position.x = Math.cos(targetX) * distance;
                camera.position.z = Math.sin(targetX) * distance;
                camera.position.y = Math.max(1, distance * Math.sin(targetY * 0.5) + 3);
                camera.lookAt(0, 0, 0);
            }
        }
        
        function createRoom() {
            // æ—¢å­˜ã®éƒ¨å±‹ã‚’å‰Šé™¤
            if (room) {
                scene.remove(room);
            }
            
            // éƒ¨å±‹ã®ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
            room = new THREE.Group();
            
            // åºŠ
            const floorGeometry = new THREE.PlaneGeometry(roomWidth, roomDepth);
            const floorMaterial = new THREE.MeshLambertMaterial({ color: 0xDEB887 });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            room.add(floor);
            
            // å£
            const wallMaterial = new THREE.MeshLambertMaterial({ color: 0xF5F5DC });
            
            // èƒŒé¢ã®å£
            const backWallGeometry = new THREE.PlaneGeometry(roomWidth, roomHeight);
            const backWall = new THREE.Mesh(backWallGeometry, wallMaterial);
            backWall.position.set(0, roomHeight/2, -roomDepth/2);
            room.add(backWall);
            
            // å·¦ã®å£
            const leftWallGeometry = new THREE.PlaneGeometry(roomDepth, roomHeight);
            const leftWall = new THREE.Mesh(leftWallGeometry, wallMaterial);
            leftWall.position.set(-roomWidth/2, roomHeight/2, 0);
            leftWall.rotation.y = Math.PI / 2;
            room.add(leftWall);
            
            // å³ã®å£
            const rightWall = new THREE.Mesh(leftWallGeometry, wallMaterial);
            rightWall.position.set(roomWidth/2, roomHeight/2, 0);
            rightWall.rotation.y = -Math.PI / 2;
            room.add(rightWall);
            
            scene.add(room);
        }
        
        function addFurniture(type) {
            const def = furnitureDefinitions[type];
            if (!def) return;
            
            const geometry = new THREE.BoxGeometry(def.width, def.height, def.depth);
            const material = new THREE.MeshLambertMaterial({ color: def.color });
            const furnitureMesh = new THREE.Mesh(geometry, material);
            
            // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã«é…ç½®ï¼ˆéƒ¨å±‹ã®ç¯„å›²å†…ï¼‰
            const x = (Math.random() - 0.5) * (roomWidth - def.width);
            const z = (Math.random() - 0.5) * (roomDepth - def.depth);
            furnitureMesh.position.set(x, def.height/2, z);
            
            furnitureMesh.castShadow = true;
            furnitureMesh.receiveShadow = true;
            furnitureMesh.userData = { type: type, name: def.name };
            
            scene.add(furnitureMesh);
            furniture.push(furnitureMesh);
            
            showNotification(`${def.name}ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
            updateStats();
        }
        
        function clearFurniture() {
            furniture.forEach(item => scene.remove(item));
            furniture = [];
            selectedObject = null;
            showNotification('å®¶å…·ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸ');
            updateStats();
        }
        
        function updateRoom() {
            roomWidth = parseFloat(document.getElementById('roomWidth').value);
            roomDepth = parseFloat(document.getElementById('roomDepth').value);
            roomHeight = parseFloat(document.getElementById('roomHeight').value);
            
            createRoom();
            showNotification('éƒ¨å±‹ã®ã‚µã‚¤ã‚ºã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            updateStats();
        }
        
        function applyLayout(layoutType) {
            clearFurniture();
            
            const layouts = {
                study: [
                    { type: 'desk', x: 1, z: -1 },
                    { type: 'chair', x: 1, z: -0.3 },
                    { type: 'bookshelf', x: -1.5, z: -1 },
                    { type: 'bed', x: -0.5, z: 1 }
                ],
                bedroom: [
                    { type: 'bed', x: 0, z: -0.5 },
                    { type: 'wardrobe', x: -1.5, z: 1 },
                    { type: 'desk', x: 1.2, z: 0.8 },
                    { type: 'chair', x: 1.2, z: 0.3 }
                ],
                workspace: [
                    { type: 'desk', x: 0, z: -1 },
                    { type: 'chair', x: 0, z: -0.3 },
                    { type: 'bookshelf', x: -1.5, z: 0 },
                    { type: 'bookshelf', x: 1.5, z: 0 }
                ],
                minimal: [
                    { type: 'bed', x: -1, z: 0 },
                    { type: 'desk', x: 1, z: -0.5 },
                    { type: 'chair', x: 1, z: 0.2 }
                ]
            };
            
            const layout = layouts[layoutType];
            if (layout) {
                layout.forEach(item => {
                    const def = furnitureDefinitions[item.type];
                    const geometry = new THREE.BoxGeometry(def.width, def.height, def.depth);
                    const material = new THREE.MeshLambertMaterial({ color: def.color });
                    const furnitureMesh = new THREE.Mesh(geometry, material);
                    
                    furnitureMesh.position.set(item.x, def.height/2, item.z);
                    furnitureMesh.castShadow = true;
                    furnitureMesh.receiveShadow = true;
                    furnitureMesh.userData = { type: item.type, name: def.name };
                    
                    scene.add(furnitureMesh);
                    furniture.push(furnitureMesh);
                });
                
                showNotification(`${layoutType}ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é©ç”¨ã—ã¾ã—ãŸ`);
                updateStats();
            }
        }
        
        function sendToClaude() {
            const input = document.getElementById('claudeInput');
            const chat = document.getElementById('claudeChat');
            const userMessage = input.value.trim();
            
            if (!userMessage) return;
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            chat.innerHTML += `<div style="margin-top: 10px;"><strong>ã‚ãªãŸ:</strong> ${userMessage}</div>`;
            
            // Claude ã®å¿œç­”ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
            setTimeout(() => {
                const responses = [
                    "ãã®ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ç´ æ™´ã‚‰ã—ã„ã§ã™ã­ï¼ãƒ™ãƒƒãƒ‰ã‚’çª“éš›ã«ç§»å‹•ã™ã‚‹ã¨ã€è‡ªç„¶å…‰ã‚’æœ‰åŠ¹æ´»ç”¨ã§ãã¾ã™ã€‚è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã‹ï¼Ÿ",
                    "åç´ã‚’å¢—ã‚„ã™ãªã‚‰ã€ç¸¦å‹ã®å®¶å…·ã‚’æ´»ç”¨ã™ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚æœ¬æ£šã‚„ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆã‚’å£éš›ã«é…ç½®ã—ã¦ã¿ã¦ãã ã•ã„ã€‚",
                    "å‹•ç·šã‚’æ”¹å–„ã™ã‚‹ã«ã¯ã€ã‚ˆãä½¿ã†å®¶å…·ã®é–“ã«ååˆ†ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ç¾åœ¨ã®é…ç½®ã‚’åˆ†æã—ã¦ã¿ã¾ã™ã­ã€‚",
                    "é–‹æ”¾æ„Ÿã‚’å‡ºã™ã«ã¯ã€éƒ¨å±‹ã®ä¸­å¤®ã«å¤§ããªå®¶å…·ã‚’ç½®ã‹ãªã„ã“ã¨ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚å£éš›é…ç½®ã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚",
                    "ä½œæ¥­åŠ¹ç‡ã‚’ä¸Šã’ã‚‹ãªã‚‰ã€ãƒ‡ã‚¹ã‚¯ã‚’è‡ªç„¶å…‰ã®å…¥ã‚‹å ´æ‰€ã«é…ç½®ã—ã€å¿…è¦ãªç‰©ã‚’æ‰‹ã®å±Šãç¯„å›²ã«ç½®ãã®ãŒåŠ¹æœçš„ã§ã™ã€‚"
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                chat.innerHTML += `<div style="margin-top: 10px;"><strong style="color: #667eea;">Claude:</strong> ${randomResponse}</div>`;
                chat.scrollTop = chat.scrollHeight;
            }, 1000);
            
            input.value = '';
            chat.scrollTop = chat.scrollHeight;
        }
        
        function handleChatEnter(event) {
            if (event.key === 'Enter') {
                sendToClaude();
            }
        }
        
        function updateStats() {
            // ç°¡æ˜“çš„ãªçµ±è¨ˆè¨ˆç®—
            const totalArea = roomWidth * roomDepth;
            const usedArea = furniture.reduce((sum, item) => {
                const def = furnitureDefinitions[item.userData.type];
                return sum + (def.width * def.depth);
            }, 0);
            
            const utilizationRate = Math.round((usedArea / totalArea) * 100);
            const walkingDistance = (furniture.length * 0.5 + 2).toFixed(1);
            const openSpace = Math.max(0, 100 - utilizationRate);
            
            document.getElementById('utilizationRate').textContent = utilizationRate + '%';
            document.getElementById('walkingDistance').textContent = walkingDistance + 'm';
            document.getElementById('openSpace').textContent = openSpace + '%';
            
            // åŠ¹ç‡æ€§è©•ä¾¡
            let efficiency = 'D';
            if (utilizationRate > 80) efficiency = 'A';
            else if (utilizationRate > 60) efficiency = 'B';
            else if (utilizationRate > 40) efficiency = 'C';
            
            document.getElementById('efficiency').textContent = efficiency;
        }
        
        function exportToBlender() {
            let blenderCode = `import bpy
import bmesh

# æ—¢å­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤
bpy.ops.object.select_all(action='SELECT')
bpy.ops.object.delete(use_global=False)

# éƒ¨å±‹ã®ä½œæˆ
bpy.ops.mesh.primitive_cube_add(size=2, location=(0, 0, ${roomHeight/2}))
room = bpy.context.active_object
room.scale = (${roomWidth/2}, ${roomDepth/2}, ${roomHeight/2})
room.name = "Room"

# åºŠãƒãƒ†ãƒªã‚¢ãƒ«
floor_material = bpy.data.materials.new(name="Floor")
floor_material.use_nodes = True
floor_material.node_tree.nodes["Principled BSDF"].inputs[0].default_value = (0.87, 0.72, 0.53, 1.0)
room.data.materials.append(floor_material)

`;

            furniture.forEach((item, index) => {
                const def = furnitureDefinitions[item.userData.type];
                const pos = item.position;
                blenderCode += `
# ${def.name}
bpy.ops.mesh.primitive_cube_add(location=(${pos.x.toFixed(2)}, ${pos.z.toFixed(2)}, ${(def.height/2).toFixed(2)}))
${item.userData.type}_${index} = bpy.context.active_object
${item.userData.type}_${index}.scale = (${(def.width/2).toFixed(2)}, ${(def.depth/2).toFixed(2)}, ${(def.height/2).toFixed(2)})
${item.userData.type}_${index}.name = "${def.name}_${index}"
`;
            });
            
            blenderCode += `
print("éƒ¨å±‹ã®3Dãƒ¢ãƒ‡ãƒ«ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼")
`;
            
            // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const blob = new Blob([blenderCode], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'room_layout.py';
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Blenderã‚³ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
        }
        
        function saveLayout() {
            const layoutData = {
                room: { width: roomWidth, depth: roomDepth, height: roomHeight },
                furniture: furniture.map(item => ({
                    type: item.userData.type,
                    position: item.position,
                    name: item.userData.name
                }))
            };
            
            const blob = new Blob([JSON.stringify(layoutData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'room_layout.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        }
        
        function takeScreenshot() {
            const canvas = document.getElementById('roomViewer');
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'room_screenshot.png';
                a.click();
                URL.revokeObjectURL(url);
                showNotification('ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            });
        }
        
        function resetCamera() {
            camera.position.set(5, 4, 5);
            camera.lookAt(0, 0, 0);
            showNotification('ã‚«ãƒ¡ãƒ©è¦–ç‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        }
        
        function toggleWireframe() {
            showWireframe = !showWireframe;
            furniture.forEach(item => {
                item.material.wireframe = showWireframe;
            });
            if (room) {
                room.children.forEach(child => {
                    if (child.material) child.material.wireframe = showWireframe;
                });
            }
            showNotification(showWireframe ? 'ãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¤ºON' : 'ãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¤ºOFF');
        }
        
        function toggleGrid() {
            showGrid = !showGrid;
            const grid = scene.getObjectByName('grid');
            if (grid) grid.visible = showGrid;
            showNotification(showGrid ? 'ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºON' : 'ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºOFF');
        }
        
        function analyzeSpace() {
            showLoading(true);
            setTimeout(() => {
                updateStats();
                showLoading(false);
                showNotification('ç©ºé–“åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ');
            }, 1500);
        }
        
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }
        
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        window.addEventListener('resize', () => {
            const canvas = document.getElementById('roomViewer');
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        });
        
        // åˆæœŸçµ±è¨ˆæ›´æ–°
        updateStats();
    </script>
</body>
</html>